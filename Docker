# Use Miniconda as the base image
FROM continuumio/miniconda3:latest

# Install system dependencies
RUN apt-get update && apt-get install -y \
    tini \
    pkg-config \
    libmariadb-dev \
    mariadb-client \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Set the working directory inside the container
WORKDIR /app

# Copy only required dependencies first (to speed up build caching)
COPY environment.yml /app/

# Install only required packages (avoid full conda environment recreation)
RUN conda install -n base --file /app/environment.yml

# Ensure Conda is properly initialized
RUN echo "source /opt/conda/etc/profile.d/conda.sh" >> ~/.bashrc

# Install Gunicorn, Redis, and Celery inside the Conda environment
RUN conda run --no-capture-output -n base pip install gunicorn redis celery

# Copy the entire application code
COPY . /app/

# Ensure entrypoint script is copied and executable
COPY entrypoint.sh /app/entrypoint.sh
RUN chmod +x /app/entrypoint.sh

# Expose the port Django runs on
EXPOSE 8000

# Use tini as the entrypoint for better process management
ENTRYPOINT ["/usr/bin/tini", "--"]

# Run Gunicorn and Celery via the entrypoint script
CMD ["/app/entrypoint.sh"]
